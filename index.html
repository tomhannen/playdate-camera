<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PDCAM</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

  :root {
    --pd-yellow: #FFC500;
    --pd-dark: #1a1a1a;
    --pd-mid: #2a2a2a;
    --pd-light: #e0e0e0;
    --pd-white: #ffffff;
    --pd-border: #444;
    --radius: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--pd-dark);
    color: var(--pd-light);
    font-family: 'Space Mono', monospace;
    touch-action: manipulation;
  }

  /* ===== PORTRAIT LAYOUT ===== */
  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-height: 100dvh;
    padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--pd-mid);
    border-bottom: 2px solid var(--pd-yellow);
    flex-shrink: 0;
  }

  .logo { font-weight: 700; font-size: 15px; color: var(--pd-yellow); letter-spacing: -0.5px; }
  .logo span { color: var(--pd-light); font-weight: 400; }

  .res-badge {
    font-size: 11px; color: var(--pd-dark); background: var(--pd-yellow);
    padding: 2px 8px; border-radius: 3px; font-weight: 700;
  }

  .preview-container {
    flex: 1; display: flex; align-items: center; justify-content: center;
    background: #000; position: relative; overflow: hidden; min-height: 0;
  }

  .preview-container canvas {
    image-rendering: pixelated; image-rendering: -webkit-optimize-contrast;
    max-width: 100%; max-height: 100%; background: #000;
  }

  video { display: none; }

  .start-overlay {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center; background: rgba(0,0,0,0.85);
    z-index: 10; gap: 16px;
  }
  .start-overlay.hidden { display: none; }

  .start-btn {
    font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700;
    color: var(--pd-dark); background: var(--pd-yellow); border: none;
    padding: 14px 32px; border-radius: var(--radius); cursor: pointer;
  }
  .start-btn:active { opacity: 0.8; transform: scale(0.97); }
  .start-hint { font-size: 13px; color: #888; text-align: center; max-width: 260px; line-height: 1.5; }

  /* Controls */
  .controls {
    flex-shrink: 0; background: var(--pd-mid); border-top: 2px solid var(--pd-border);
    padding: 10px 16px 14px; display: flex; flex-direction: column; gap: 8px;
  }

  .control-row { display: flex; align-items: center; gap: 8px; }

  .control-label {
    font-size: 10px; font-weight: 700; color: var(--pd-yellow);
    text-transform: uppercase; letter-spacing: 1px; min-width: 52px; flex-shrink: 0;
  }

  .control-value { font-size: 10px; color: var(--pd-light); min-width: 28px; text-align: right; flex-shrink: 0; }

  input[type="range"] {
    -webkit-appearance: none; appearance: none; flex: 1; height: 28px;
    background: transparent; outline: none;
  }
  input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: var(--pd-border); border-radius: 2px; }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%;
    background: var(--pd-yellow); border: 2px solid var(--pd-dark); margin-top: -9px;
  }

  .dither-options { display: flex; gap: 5px; flex: 1; flex-wrap: nowrap; overflow-x: auto; }

  .dither-btn {
    font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700;
    padding: 5px 8px; border: 2px solid var(--pd-border); border-radius: 5px;
    background: transparent; color: var(--pd-light); cursor: pointer;
    white-space: nowrap; flex-shrink: 0;
  }
  .dither-btn.active { border-color: var(--pd-yellow); background: var(--pd-yellow); color: var(--pd-dark); }

  .actions { display: flex; gap: 6px; }

  .action-btn {
    flex: 1; font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700;
    padding: 10px 6px; border: 2px solid var(--pd-border); border-radius: var(--radius);
    background: transparent; color: var(--pd-light); cursor: pointer;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .action-btn.primary { border-color: var(--pd-yellow); background: var(--pd-yellow); color: var(--pd-dark); }
  .action-btn:active { opacity: 0.7; transform: scale(0.97); }
  .action-btn.flash { animation: flashSave 0.4s ease; }

  @keyframes flashSave {
    0% { background: var(--pd-yellow); }
    50% { background: var(--pd-white); }
    100% { background: var(--pd-yellow); }
  }

  .toast {
    position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-100px);
    background: var(--pd-yellow); color: var(--pd-dark); font-size: 12px; font-weight: 700;
    padding: 10px 20px; border-radius: var(--radius); z-index: 100; opacity: 0;
    transition: all 0.3s ease; pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

  /* ===== LANDSCAPE LAYOUT ===== */
  @media (orientation: landscape) {
    .app {
      flex-direction: row;
      padding: 0 env(safe-area-inset-right) 0 env(safe-area-inset-left);
    }

    .header { display: none; }

    .preview-container { flex: 1; height: 100dvh; }

    .controls {
      width: 160px;
      flex-shrink: 0;
      height: 100dvh;
      border-top: none;
      border-left: 2px solid var(--pd-yellow);
      padding: 8px;
      gap: 6px;
      justify-content: center;
      overflow-y: auto;
    }

    .control-row { flex-wrap: wrap; gap: 3px; }
    .control-label { font-size: 9px; min-width: 100%; margin-bottom: 0; }
    .control-value { font-size: 9px; }
    input[type="range"] { height: 22px; }
    input[type="range"]::-webkit-slider-thumb { width: 18px; height: 18px; margin-top: -7px; }

    .dither-options { flex-wrap: wrap; gap: 3px; }
    .dither-btn { font-size: 9px; padding: 3px 5px; }

    .actions { flex-direction: column; gap: 3px; }
    .action-btn { font-size: 10px; padding: 8px 4px; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">PD<span>CAM</span></div>
    <div class="res-badge">400×240 · 1-BIT</div>
  </div>

  <div class="preview-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="output" width="400" height="240"></canvas>
    <div class="start-overlay" id="startOverlay">
      <div class="logo" style="font-size:28px;">PD<span>CAM</span></div>
      <button class="start-btn" id="startBtn">START CAMERA</button>
      <div class="start-hint">1-bit dithered photos for Playdate</div>
    </div>
  </div>

  <div class="controls">
    <div class="control-row">
      <div class="control-label">Thresh</div>
      <input type="range" id="threshold" min="0" max="255" value="128">
      <div class="control-value" id="threshVal">128</div>
    </div>
    <div class="control-row">
      <div class="control-label">Dither</div>
      <div class="dither-options" id="ditherOptions">
        <button class="dither-btn active" data-dither="floyd">Floyd</button>
        <button class="dither-btn" data-dither="atkinson">Atkin</button>
        <button class="dither-btn" data-dither="bayer4">Bay4</button>
        <button class="dither-btn" data-dither="bayer8">Bay8</button>
        <button class="dither-btn" data-dither="none">None</button>
      </div>
    </div>
    <div class="actions">
      <button class="action-btn" id="flipBtn">FLIP</button>
      <button class="action-btn" id="freezeBtn">FREEZE</button>
      <button class="action-btn primary" id="saveBtn">SAVE</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<canvas id="captureCanvas" style="display:none;"></canvas>

<script>
const video = document.getElementById('video');
const output = document.getElementById('output');
const ctx = output.getContext('2d', { willReadFrequently: true });
const captureCanvas = document.getElementById('captureCanvas');
const captureCtx = captureCanvas.getContext('2d', { willReadFrequently: true });

const thresholdSlider = document.getElementById('threshold');
const threshVal = document.getElementById('threshVal');
const ditherOptions = document.getElementById('ditherOptions');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const saveBtn = document.getElementById('saveBtn');
const flipBtn = document.getElementById('flipBtn');
const freezeBtn = document.getElementById('freezeBtn');
const toast = document.getElementById('toast');

const PD_W = 400, PD_H = 240;

let currentDither = 'floyd';
let threshold = 128;
let running = false;
let frozen = false;
let facingMode = 'environment';
let stream = null;

const BAYER4 = [
  [ 0, 8, 2,10],[12, 4,14, 6],[ 3,11, 1, 9],[15, 7,13, 5]
];
const BAYER8 = [
  [ 0,32, 8,40, 2,34,10,42],[48,16,56,24,50,18,58,26],
  [12,44, 4,36,14,46, 6,38],[60,28,52,20,62,30,54,22],
  [ 3,35,11,43, 1,33, 9,41],[51,19,59,27,49,17,57,25],
  [15,47, 7,39,13,45, 5,37],[63,31,55,23,61,29,53,21]
];

function getCrop(vw, vh) {
  const ta = PD_W / PD_H, va = vw / vh;
  if (va > ta) { const sh = vh, sw = vh * ta; return [(vw-sw)/2, 0, sw, sh]; }
  else { const sw = vw, sh = vw / ta; return [0, (vh-sh)/2, sw, sh]; }
}

function processFrame() {
  if (!running || frozen) return;
  const vw = video.videoWidth, vh = video.videoHeight;
  if (!vw || !vh) { requestAnimationFrame(processFrame); return; }

  const [sx, sy, sw, sh] = getCrop(vw, vh);
  ctx.drawImage(video, sx, sy, sw, sh, 0, 0, PD_W, PD_H);

  const imageData = ctx.getImageData(0, 0, PD_W, PD_H);
  const px = imageData.data;
  for (let i = 0; i < px.length; i += 4) {
    const g = 0.299*px[i] + 0.587*px[i+1] + 0.114*px[i+2];
    px[i] = px[i+1] = px[i+2] = g;
  }

  applyDither(imageData, currentDither, threshold);
  ctx.putImageData(imageData, 0, 0);
  requestAnimationFrame(processFrame);
}

function applyDither(imageData, method, thresh) {
  const { data, width, height } = imageData;

  if (method === 'none') {
    for (let i = 0; i < data.length; i += 4) {
      const v = data[i] >= thresh ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = v;
    }
    return;
  }

  if (method === 'bayer4' || method === 'bayer8') {
    const matrix = method === 'bayer4' ? BAYER4 : BAYER8;
    const n = matrix.length;
    const scale = method === 'bayer4' ? 16 : 64;
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const idx = (y * width + x) * 4;
        const gray = data[idx];
        const bayerNorm = (matrix[y%n][x%n] + 0.5) / scale;
        const adjusted = gray + (bayerNorm - 0.5) * 255;
        const v = adjusted >= thresh ? 255 : 0;
        data[idx] = data[idx+1] = data[idx+2] = v;
      }
    }
    return;
  }

  // Error diffusion: Floyd-Steinberg / Atkinson
  // Threshold acts as a brightness offset so the slider has visible effect.
  // thresh=128 is neutral. Lower = brighter, higher = darker.
  const gray = new Float32Array(width * height);
  for (let i = 0; i < gray.length; i++) {
    gray[i] = data[i * 4] + (128 - thresh);
  }

  const kernel = method === 'floyd'
    ? [[1,0,7/16],[-1,1,3/16],[0,1,5/16],[1,1,1/16]]
    : [[1,0,1/8],[2,0,1/8],[-1,1,1/8],[0,1,1/8],[1,1,1/8],[0,2,1/8]];

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const idx = y * width + x;
      const old = gray[idx];
      const nv = old >= 128 ? 255 : 0;
      gray[idx] = nv;
      const err = old - nv;
      for (const [dx, dy, f] of kernel) {
        const nx = x+dx, ny = y+dy;
        if (nx >= 0 && nx < width && ny < height) gray[ny*width+nx] += err * f;
      }
    }
  }

  for (let i = 0; i < gray.length; i++) {
    const v = gray[i] >= 128 ? 255 : 0;
    data[i*4] = data[i*4+1] = data[i*4+2] = v;
  }
}

async function startCamera() {
  try {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false
    });
    video.srcObject = stream;
    await video.play();
    running = true; frozen = false;
    freezeBtn.textContent = 'FREEZE';
    startOverlay.classList.add('hidden');
    processFrame();
  } catch (err) { showToast('Camera access denied'); console.error(err); }
}

thresholdSlider.addEventListener('input', () => {
  threshold = parseInt(thresholdSlider.value);
  threshVal.textContent = threshold;
  if (frozen) reprocessFrozen();
});

ditherOptions.addEventListener('click', (e) => {
  const btn = e.target.closest('.dither-btn');
  if (!btn) return;
  ditherOptions.querySelectorAll('.dither-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentDither = btn.dataset.dither;
  if (frozen) reprocessFrozen();
});

startBtn.addEventListener('click', startCamera);

flipBtn.addEventListener('click', () => {
  facingMode = facingMode === 'environment' ? 'user' : 'environment';
  if (running) startCamera();
});

freezeBtn.addEventListener('click', () => {
  if (!running) return;
  if (!frozen) {
    frozen = true;
    freezeBtn.textContent = 'LIVE';
    captureCanvas.width = PD_W; captureCanvas.height = PD_H;
    const vw = video.videoWidth, vh = video.videoHeight;
    const [sx, sy, sw, sh] = getCrop(vw, vh);
    captureCtx.drawImage(video, sx, sy, sw, sh, 0, 0, PD_W, PD_H);
    const imgData = captureCtx.getImageData(0, 0, PD_W, PD_H);
    for (let i = 0; i < imgData.data.length; i += 4) {
      const g = 0.299*imgData.data[i] + 0.587*imgData.data[i+1] + 0.114*imgData.data[i+2];
      imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = g;
    }
    captureCtx.putImageData(imgData, 0, 0);
    reprocessFrozen();
  } else {
    frozen = false;
    freezeBtn.textContent = 'FREEZE';
    processFrame();
  }
});

function reprocessFrozen() {
  const srcData = captureCtx.getImageData(0, 0, PD_W, PD_H);
  const outData = ctx.createImageData(PD_W, PD_H);
  outData.data.set(srcData.data);
  applyDither(outData, currentDither, threshold);
  ctx.putImageData(outData, 0, 0);
}

saveBtn.addEventListener('click', () => {
  const c = document.createElement('canvas');
  c.width = PD_W; c.height = PD_H;
  c.getContext('2d').drawImage(output, 0, 0);
  c.toBlob((blob) => {
    if (!blob) { showToast('Save failed'); return; }
    if (navigator.share && navigator.canShare) {
      const file = new File([blob], 'playdate-photo.png', { type: 'image/png' });
      if (navigator.canShare({ files: [file] })) {
        navigator.share({ files: [file] }).then(() => showToast('Shared!')).catch(() => fallbackDL(blob));
        return;
      }
    }
    fallbackDL(blob);
  }, 'image/png');
  saveBtn.classList.add('flash');
  setTimeout(() => saveBtn.classList.remove('flash'), 400);
});

function fallbackDL(blob) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'playdate-photo.png';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  showToast('PNG saved!');
}

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}
</script>
</body>
</html>
